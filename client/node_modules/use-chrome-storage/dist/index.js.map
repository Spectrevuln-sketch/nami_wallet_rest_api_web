{"version":3,"file":"index.js","sources":["../src/useChromeStorage.js","../src/storage.js","../src/createChromeStorageStateHook.js","../src/index.js"],"sourcesContent":["import {useCallback, useEffect, useState} from 'react';\r\nimport {storage} from './storage';\r\n\r\n\r\n/**\r\n * Basic hook for storage\r\n * @param {string} key\r\n * @param {*} initialValue\r\n * @param {'local'|'sync'} storageArea\r\n * @returns {[*, function(*= any): void, boolean, string]}\r\n */\r\nexport default function useChromeStorage(key, initialValue, storageArea) {\r\n    const [INITIAL_VALUE] = useState(() => {\r\n        return typeof initialValue === 'function' ? initialValue() : initialValue;\r\n    });\r\n    const [STORAGE_AREA] = useState(storageArea);\r\n    const [state, setState] = useState(INITIAL_VALUE);\r\n    const [isPersistent, setIsPersistent] = useState(true);\r\n    const [error, setError] = useState('');\r\n\r\n    useEffect(() => {\r\n        storage.get(key, INITIAL_VALUE, STORAGE_AREA)\r\n            .then(res => {\r\n                setState(res);\r\n                setIsPersistent(true);\r\n                setError('');\r\n            })\r\n            .catch(error => {\r\n                setIsPersistent(false);\r\n                setError(error);\r\n            });\r\n    }, [key, INITIAL_VALUE, STORAGE_AREA]);\r\n\r\n    const updateValue = useCallback((newValue) => {\r\n        const toStore = typeof newValue === 'function' ? newValue(state) : newValue;\r\n        setState(toStore);\r\n        storage.set(key, toStore, STORAGE_AREA)\r\n            .then(() => {\r\n                setIsPersistent(true);\r\n                setError('');\r\n            })\r\n            .catch(error => {\r\n                setIsPersistent(false);\r\n                setError(error);\r\n            });\r\n    }, [STORAGE_AREA, key, state]);\r\n\r\n    useEffect(() => {\r\n        const onChange = (changes, areaName) => {\r\n            if (areaName === STORAGE_AREA && key in changes) {\r\n                setState(changes[key].newValue);\r\n                setIsPersistent(true);\r\n                setError('');\r\n            }\r\n        };\r\n        chrome.storage.onChanged.addListener(onChange);\r\n        return () => {\r\n            chrome.storage.onChanged.removeListener(onChange);\r\n        };\r\n    }, [key, STORAGE_AREA]);\r\n\r\n    return [state, updateValue, isPersistent, error];\r\n}\r\n","export const storage = {\r\n    get: (key, defaultValue, storageArea) => {\r\n        const keyObj = defaultValue === undefined ? key : {[key]: defaultValue};\r\n        return new Promise((resolve, reject) => {\r\n            chrome.storage[storageArea].get(keyObj, items => {\r\n                const error = chrome.runtime.lastError;\r\n                if (error) return reject(error);\r\n                resolve(items[key]);\r\n            });\r\n        });\r\n    },\r\n    set: (key, value, storageArea) => {\r\n        return new Promise((resolve, reject) => {\r\n            chrome.storage[storageArea].set({[key]: value}, () => {\r\n                const error = chrome.runtime.lastError;\r\n                error ? reject(error) : resolve();\r\n            });\r\n        });\r\n    },\r\n};\r\n","import {useCallback, useEffect} from 'react';\r\nimport useChromeStorage from './useChromeStorage';\r\n\r\n\r\nexport default function createChromeStorageStateHook(key, initialValue, storageArea) {\r\n    const consumers = [];\r\n\r\n    return function useCreateChromeStorageHook() {\r\n        const [value, setValue, isPersistent, error] = useChromeStorage(key, initialValue, storageArea);\r\n\r\n        const setValueAll = useCallback(newValue => {\r\n            for (const consumer of consumers) {\r\n                consumer(newValue);\r\n            }\r\n        }, []);\r\n\r\n        useEffect(() => {\r\n            consumers.push(setValue);\r\n            return () => {\r\n                consumers.splice(consumers.indexOf(setValue), 1);\r\n            };\r\n        }, [setValue]);\r\n\r\n        return [value, setValueAll, isPersistent, error];\r\n    };\r\n}\r\n","import useChromeStorage from './useChromeStorage';\r\nimport createChromeStorageStateHook from './createChromeStorageStateHook';\r\n\r\n\r\n/**\r\n * Hook which will use `chrome.storage.local` to persist state.\r\n *\r\n * @param {string} key - they key name in chrome's storage. Nested keys not supported\r\n * @param {*} [initialValue] - default value to use\r\n * @returns {[any, (value: any) => void, boolean, string]} - array of\r\n *      stateful `value`,\r\n *      function to update this `value`,\r\n *      `isPersistent` - will be `false` if error occurred during reading/writing chrome.storage,\r\n *      `error` - will contain error appeared in storage. if isPersistent is true will be empty string\r\n */\r\nfunction useChromeStorageLocal(key, initialValue) {\r\n    return useChromeStorage(key, initialValue, 'local');\r\n}\r\n\r\n/**\r\n * Hook which will use `chrome.storage.sync` to persist state.\r\n *\r\n * @param {string} key - they key name in chrome's storage. Nested keys not supported\r\n * @param {*} [initialValue] - default value to use\r\n * @returns {[any, (value: any) => void, boolean, string]} - array of\r\n *      stateful `value`,\r\n *      function to update this `value`,\r\n *      `isPersistent` - will be `false` if error occurred during reading/writing chrome.storage,\r\n *      `error` - will contain error appeared in storage. if isPersistent is true will be empty string\r\n */\r\nfunction useChromeStorageSync(key, initialValue) {\r\n    return useChromeStorage(key, initialValue, 'sync');\r\n}\r\n\r\n/**\r\n * Use to create state with chrome.storage.local.\r\n * Useful if you want to reuse same state across components and/or context (like in popup, content script, background pages)\r\n *\r\n * @param {string} key - they key name in chrome's storage. Nested keys not supported\r\n * @param {*} [initialValue] - default value to use\r\n * @returns {function(): [any, (value: any) => void, boolean, string]}\r\n */\r\nfunction createChromeStorageStateHookLocal(key, initialValue) {\r\n    return createChromeStorageStateHook(key, initialValue, 'local');\r\n}\r\n\r\n/**\r\n * Use to create state with chrome.storage.sync.\r\n * Useful if you want to reuse same state across components and/or context (like in popup, content script, background pages)\r\n *\r\n * @param {string} key - they key name in chrome's storage. Nested keys not supported\r\n * @param {*} [initialValue] - default value to use\r\n * @returns {function(): [any, (value: any) => void, boolean, string]}\r\n */\r\nfunction createChromeStorageStateHookSync(key, initialValue) {\r\n    return createChromeStorageStateHook(key, initialValue, 'sync');\r\n}\r\n\r\nexport {\r\n    useChromeStorageLocal,\r\n    useChromeStorageSync,\r\n    createChromeStorageStateHookLocal,\r\n    createChromeStorageStateHookSync,\r\n};\r\n"],"names":["useChromeStorage","key","initialValue","storageArea","INITIAL_VALUE","useState","STORAGE_AREA","state","setState","isPersistent","setIsPersistent","error","setError","useEffect","defaultValue","keyObj","undefined","Promise","resolve","reject","chrome","storage","get","items","runtime","lastError","then","res","catch","updateValue","useCallback","newValue","toStore","value","set","onChange","changes","areaName","onChanged","addListener","removeListener","createChromeStorageStateHook","consumers","setValue","setValueAll","consumer","push","splice","indexOf"],"mappings":"gCAWwBA,EAAiBC,EAAKC,EAAcC,GACxD,MAAOC,GAAiBC,WAAS,IACE,mBAAjBH,EAA8BA,IAAiBA,IAE1DI,GAAgBD,WAASF,IACzBI,EAAOC,GAAYH,WAASD,IAC5BK,EAAcC,GAAmBL,YAAS,IAC1CM,EAAOC,GAAYP,WAAS,IAEnCQ,YAAU,KCnBL,EAACZ,EAAKa,EAAcX,KACrB,MAAMY,OAA0BC,IAAjBF,EAA6Bb,EAAM,CAACA,CAACA,GAAMa,GAC1D,WAAWG,QAAQ,CAACC,EAASC,KACzBC,OAAOC,QAAQlB,GAAamB,IAAIP,EAAQQ,IACpC,MAAMZ,EAAQS,OAAOI,QAAQC,UAC7B,GAAId,EAAO,OAAOQ,EAAOR,GACzBO,EAAQK,EAAMtB,SDctBoB,CAAYpB,EAAKG,EAAeE,GAC3BoB,KAAKC,IACFnB,EAASmB,GACTjB,GAAgB,GAChBE,EAAS,MAEZgB,MAAMjB,IACHD,GAAgB,GAChBE,EAASD,MAElB,CAACV,EAAKG,EAAeE,IAExB,MAAMuB,EAAcC,cAAaC,IAC7B,MAAMC,EAA8B,mBAAbD,EAA0BA,EAASxB,GAASwB,EACnEvB,EAASwB,GCxBR,EAAC/B,EAAKgC,EAAO9B,QACHc,QAAQ,CAACC,EAASC,KACzBC,OAAOC,QAAQlB,GAAa+B,IAAI,CAACjC,CAACA,GAAMgC,GAAQ,KAC5C,MAAMtB,EAAQS,OAAOI,QAAQC,UAC7Bd,EAAQQ,EAAOR,GAASO,QDqBhCG,CAAYpB,EAAK+B,EAAS1B,GACrBoB,KAAK,KACFhB,GAAgB,GAChBE,EAAS,MAEZgB,MAAMjB,IACHD,GAAgB,GAChBE,EAASD,MAElB,CAACL,EAAcL,EAAKM,IAgBvB,OAdAM,YAAU,KACN,MAAMsB,EAAW,CAACC,EAASC,KACnBA,IAAa/B,GAAgBL,KAAOmC,IACpC5B,EAAS4B,EAAQnC,GAAK8B,UACtBrB,GAAgB,GAChBE,EAAS,MAIjB,OADAQ,OAAOC,QAAQiB,UAAUC,YAAYJ,GAC9B,KACHf,OAAOC,QAAQiB,UAAUE,eAAeL,KAE7C,CAAClC,EAAKK,IAEF,CAACC,EAAOsB,EAAapB,EAAcE,YEzDtB8B,EAA6BxC,EAAKC,EAAcC,GACpE,MAAMuC,EAAY,GAElB,kBACI,MAAOT,EAAOU,EAAUlC,EAAcE,GAASX,EAAiBC,EAAKC,EAAcC,GAE7EyC,EAAcd,cAAYC,IAC5B,IAAK,MAAMc,KAAYH,EACnBG,EAASd,IAEd,IASH,OAPAlB,YAAU,KACN6B,EAAUI,KAAKH,GACR,KACHD,EAAUK,OAAOL,EAAUM,QAAQL,GAAW,KAEnD,CAACA,IAEG,CAACV,EAAOW,EAAanC,EAAcE,8CCmBlD,SAA2CV,EAAKC,GAC5C,OAAOuC,EAA6BxC,EAAKC,EAAc,mDAW3D,SAA0CD,EAAKC,GAC3C,OAAOuC,EAA6BxC,EAAKC,EAAc,uCAxC3D,SAA+BD,EAAKC,GAChC,OAAOF,EAAiBC,EAAKC,EAAc,uCAc/C,SAA8BD,EAAKC,GAC/B,OAAOF,EAAiBC,EAAKC,EAAc"}